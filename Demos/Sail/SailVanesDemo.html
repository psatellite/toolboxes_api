
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>Demonstrate computing angles for a sail with a pair of vanes.</title><meta name="generator" content="MATLAB 9.11"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2022-09-20"><meta name="DC.source" content="SailVanesDemo.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; }

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }
span.typesection { color:#A0522D }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h1>Demonstrate computing angles for a sail with a pair of vanes.</h1><!--introduction--><p>Explore effects of sail cone angle on vane control output. Uses a 2 vane example (PlateWithVanes).</p><pre class="language-matlab">Since <span class="string">version</span> <span class="string">9.</span>
------------------------------------------------------------------------
See <span class="string">also</span> <span class="string">SolveVaneAngles</span>, SailDisturbance, Theta0, DrawSCPlanPlugIn,
Cone, Constant, InformDlg, NewFig, Plot2D, TitleS, XLabelS, YLabelS, Unit,
Date2JD, El2RV, ConeClockToU, QSail, DisturbanceStruct, EnvironmentStruct,
ProfileStruct, SailEnvironment, CP1Props, UpdateSailOpticalProps,
ApplyProfileToModel, SailPropsToAccel
------------------------------------------------------------------------
</pre><!--/introduction--><h2>Contents</h2><div><ul><li><a href="#2">Set up the problem</a></li><li><a href="#3">Use a CAD model to get actual torque produced by vanes</a></li><li><a href="#4">Define spacecraft properties</a></li><li><a href="#5">Vane area</a></li><li><a href="#6">Maximum torque</a></li><li><a href="#7">Environment and disturbance models</a></li><li><a href="#8">Profile: orbit, attitude</a></li><li><a href="#9">Environment will be constant over this short period</a></li><li><a href="#10">Compute full disturbances for different vane angles and sail attiude</a></li><li><a href="#11">(Vanes don't produce a pure roll torque for nonzero cone angle)</a></li><li><a href="#12">Plot the curves for a single vane angle and all cone angles</a></li><li><a href="#13">Plot the torque profiles in each axis</a></li><li><a href="#14">Redo above analysis with a smaller set of vane angles</a></li><li><a href="#15">to the sun.</a></li><li><a href="#16">Investigate differential vane commanding for pure roll torque</a></li><li><a href="#17">that gives the desired torque.</a></li><li><a href="#18">A small torque is generated in the 3rd axis, increasing with cone angle.</a></li><li><a href="#19">Redo angle solving with non-ideal optical properties</a></li><li><a href="#20">degree, while for the offset angles it is less than 0.5 degree.</a></li><li><a href="#21">Animate angles (ideal case) using DrawSCPlanPlugIn</a></li></ul></div><pre class="codeinput"><span class="comment">%-------------------------------------------------------------------------------</span>
<span class="comment">%	 Copyright 2009 Princeton Satellite Systems, Inc.</span>
<span class="comment">%  All rights reserved.</span>
<span class="comment">%-------------------------------------------------------------------------------</span>
</pre><h2 id="2">Set up the problem</h2><pre class="codeinput"><span class="comment">%--------------------</span>
clear <span class="string">SailDisturbance</span>
</pre><h2 id="3">Use a CAD model to get actual torque produced by vanes</h2><pre class="codeinput"><span class="comment">%-------------------------------------------------------</span>
g = load(<span class="string">'PlateWithVanes'</span>);
</pre><h2 id="4">Define spacecraft properties</h2><pre class="codeinput"><span class="comment">%-----------------------------</span>
mass  = g.mass.mass; <span class="comment">% spacecraft mass in kg</span>
lSail = max(max(g.component(2).v)); <span class="comment">% sail length along one side in m</span>
area  = sum(g.component(2).a);
acc0  = SailPropsToAccel( area, mass );
</pre><h2 id="5">Vane area</h2><pre class="codeinput"><span class="comment">%-------------</span>
areaVane = g.component(3).a; <span class="comment">% m2</span>
</pre><h2 id="6">Maximum torque</h2><pre class="codeinput"><span class="comment">%---------------</span>
thetaMax = 80*pi/180;
Ps       = Constant(<span class="string">'solar pressure mks'</span>);
fVane    = 2*Ps*areaVane;
Tmax     = 2*lSail*fVane*sin(thetaMax);
</pre><h2 id="7">Environment and disturbance models</h2><pre class="codeinput"><span class="comment">%-----------------------------------</span>
d = struct;
d = EnvironmentStruct( d );
d = DisturbanceStruct( d );
d.aeroOn   = 0;
d.albedoOn = 0;
d.magOn    = 0;
d.radOn    = 0;
</pre><h2 id="8">Profile: orbit, attitude</h2><pre class="codeinput"><span class="comment">%-------------------------</span>
jD    = Date2JD;
[r,v] = El2RV([Constant(<span class="string">'au'</span>) 0 0 0 0 0],[],Constant(<span class="string">'mu sun'</span>));
uSun  = -Unit(r);
qS    = QSail( uSun, r, v );
p    = ProfileStruct;
p.q  = qS;
p.r  = r;
p.v  = v;
p.jD = jD;
<span class="comment">% states for rotating vanes</span>
p.body  = [2 3];
p.angle = [0; 0];
p.axis  = [0 0 1; 0 0 1]';
</pre><h2 id="9">Environment will be constant over this short period</h2><pre class="codeinput"><span class="comment">%----------------------------------------------------</span>
env = SailEnvironment( <span class="string">'sun'</span>, p, d );
</pre><h2 id="10">Compute full disturbances for different vane angles and sail attiude</h2><pre class="codeinput"><span class="comment">%----------------------------------------------------------------------</span>
disp(<span class="string">'Sail vanes demo ----------------------'</span>)

<span class="comment">% Disturbances</span>
[f, tq] = SailDisturbance( g, p, env, d );
disp(<span class="string">'Torque for all zero angles - should be zero!'</span>)
tq.total

<span class="comment">% Now rotate the vanes with the sail straight-on to the sun</span>
p.angle = [20; 20]*pi/180;
[f, tq] = SailDisturbance( g, p, env, d );
disp(<span class="string">'Torque for vanes angles of 20 degrees - pure roll torque'</span>)
tq.total

<span class="comment">% Next give the sail a cone angle - see torques in other axes</span>
cone = pi/6;
clock = 0;
[u,qItoCC] = ConeClockToU( cone, clock, qS );
p.q  = qItoCC;
[f, tq] = SailDisturbance( g, p, env, d );
disp(<span class="string">'Torque for vanes angles of 20 degrees with cone angle of 30 degrees;'</span>)
disp(<span class="string">'no longer a pure roll torque but evenly distributed in two axes.'</span>)
tq.total

<span class="comment">% Now give the sail a clock angle - no change</span>
clock = pi/4;
[u,qItoCC] = ConeClockToU( cone, clock, qS );
p.q  = qItoCC;
[f, tq] = SailDisturbance( g, p, env, d );
disp(<span class="string">'Clock angle doesn''''t change the body torques'</span>)
tq.total

<span class="comment">% Investigate the effect of cone angle on the three-axis torque produced</span>
</pre><pre class="codeoutput">Sail vanes demo ----------------------
Torque for all zero angles - should be zero!

ans =

  -9.5352e-18
   1.3878e-17
   7.5266e-17

Torque for vanes angles of 20 degrees - pure roll torque

ans =

      0.21871
            0
   7.4593e-17

Torque for vanes angles of 20 degrees with cone angle of 30 degrees;
no longer a pure roll torque but evenly distributed in two axes.

ans =

       0.1718
      0.19171
   -0.0032355

Clock angle doesn''t change the body torques

ans =

       0.1718
      0.19171
   -0.0032355

</pre><h2 id="11">(Vanes don't produce a pure roll torque for nonzero cone angle)</h2><pre class="codeinput"><span class="comment">%-----------------------------------------------------------------------</span>
cones = linspace(0,pi/4,50);
clock = 0;
vanes = [10;20;30;40;50;65;80];
zz      = zeros(length(vanes),length(cones));
torqueX = zz;
torqueY = zz;
torqueZ = zz;
<span class="keyword">for</span> k = 1:length(cones)
  [u,qItoCC(:,k)] = ConeClockToU( cones(k), clock, qS );
  p.q  = qItoCC(:,k);
  <span class="keyword">for</span> j = 1:length(vanes)
    p.angle = vanes(j)*[1; 1]*pi/180;
    [f, tq] = SailDisturbance( g, p, env, d );
    torqueX(j,k) = tq.total(1);
    torqueY(j,k) = tq.total(2);
    torqueZ(j,k) = tq.total(3);
  <span class="keyword">end</span>
<span class="keyword">end</span>
conePlot = cones*180/pi;
</pre><h2 id="12">Plot the curves for a single vane angle and all cone angles</h2><pre class="codeinput"><span class="comment">%------------------------------------------------------------</span>
<span class="comment">% Nominal curves, at 20 degrees</span>
Plot2D(conePlot,[torqueX(2,:);torqueY(2,:);torqueZ(2,:)],<span class="string">'Cone Angle'</span>,<span class="string">'Torque (Nm)'</span>,<span class="string">'Vane Torque (20 degree rotation) with cone angle'</span>)
<span class="comment">% Confirm typical magnitude curve when cone is zero</span>
Plot2D(vanes',torqueX(:,1)',<span class="string">'Vane Angle'</span>,<span class="string">'Max Torque (Nm)'</span>,<span class="string">'Vane Torque when sail cone angle is zero'</span>)
</pre><img vspace="5" hspace="5" src="SailVanesDemo_01.png" alt=""> <img vspace="5" hspace="5" src="SailVanesDemo_02.png" alt=""> <h2 id="13">Plot the torque profiles in each axis</h2><pre class="codeinput"><span class="comment">%--------------------------------------</span>
NewFig(<span class="string">'Torque Profiles'</span>)
TitleS(<span class="string">'Vane Torques For Varying Cone Angle'</span>)
subplot(2,1,1)
plot(conePlot,torqueX)
YLabelS(<span class="string">'Roll Torque (Nm)'</span>)
grid <span class="string">on</span>
subplot(2,1,2)
plot(conePlot,torqueY)
grid <span class="string">on</span>
YLabelS(<span class="string">'Overturning Torque (Nm)'</span>)
XLabelS(<span class="string">'Cone Angle'</span>)
legH = legend(num2str(vanes));
set(legH,<span class="string">'fontsize'</span>,9)
</pre><h2 id="14">Redo above analysis with a smaller set of vane angles</h2><pre class="codeinput"><span class="comment">%-------------------------------------------------------</span>
clock = 0;
vanes = 2:2:16;
torqueX = zz;
torqueY = zz;
torqueZ = zz;
<span class="keyword">for</span> k = 1:length(cones)
  p.q  = qItoCC(:,k);
  <span class="keyword">for</span> j = 1:length(vanes)
    p.angle = vanes(j)*[1; 1]*pi/180;
    [f, tq] = SailDisturbance( g, p, env, d );
    torqueX(j,k) = tq.total(1);
    torqueY(j,k) = tq.total(2);
    torqueZ(j,k) = tq.total(3);
  <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="comment">% This figure shows that when the sail has an angle to the sun, and the</span>
<span class="comment">% vanes have equal angles, an overturning torque is produced in addition to</span>
<span class="comment">% the roll torque. This is because the vanes have different apparent areas</span>
</pre><img vspace="5" hspace="5" src="SailVanesDemo_03.png" alt=""> <h2 id="15">to the sun.</h2><pre class="codeinput"><span class="comment">%--------------------------------------------------------------------------</span>
NewFig(<span class="string">'Torque Profiles'</span>)
subplot(2,1,1)
plot(conePlot,torqueX)
grid <span class="string">on</span>
YLabelS(<span class="string">'Roll Torque (Nm)'</span>)
TitleS(<span class="string">'Vane Torques For Varying Cone Angle'</span>)
subplot(2,1,2)
plot(conePlot,torqueY)
grid <span class="string">on</span>
YLabelS(<span class="string">'Overturning Torque (Nm)'</span>)
XLabelS(<span class="string">'Cone Angle'</span>)
legH = legend(num2str(vanes'));
set(legH,<span class="string">'fontsize'</span>,9)
</pre><img vspace="5" hspace="5" src="SailVanesDemo_04.png" alt=""> <h2 id="16">Investigate differential vane commanding for pure roll torque</h2><p>To achieve a pure roll torque with varying sail cone angle we have to command the vanes to different angles. SolveVaneAngles uses Newton's method with a numerical Jacobian to find the combination of vane angles</p><h2 id="17">that gives the desired torque.</h2><pre class="codeinput"><span class="comment">%---------------------------------------------------</span>
Tcommand = [0.1; 0];
<span class="comment">% Nominal angle for roll torque, for initialization</span>
theta0 = asin(Tcommand(1)./(2*lSail*fVane));
theta = [theta0;theta0];
<span class="comment">% Initialize plot matrices</span>
torqueSolved = zeros(3,length(cones));
thetas       = zeros(2,length(cones));
ks           = zeros(1,length(cones));
<span class="comment">% Informational window</span>
iH = InformDlg( <span class="string">'Running loop of SolveVaneAngles...'</span>, <span class="string">'SailVanesDemo'</span> );
<span class="keyword">for</span> k = 1:length(cones)
  p.q  = qItoCC(:,k);
  [theta,iter] = SolveVaneAngles( Tcommand, theta, g, env, p, d );
  p.angle = theta;
  [f, tq] = SailDisturbance( g, p, env, d );
  torqueSolved(:,k) = tq.total;
  thetas(:,k) = theta;
  ks(k) = iter;
<span class="keyword">end</span>
close(iH)

<span class="comment">% See that the average angle remains the same and pure roll torque is</span>
<span class="comment">% achieved. The number of iterations to meet the tolerance is shown.</span>
<span class="comment">%</span>
</pre><h2 id="18">A small torque is generated in the 3rd axis, increasing with cone angle.</h2><pre class="codeinput"><span class="comment">%-------------------------------------------------------------------------</span>
Plot2D(conePlot,thetas*180/pi,<span class="string">'Cone Angle (deg)'</span>,<span class="string">'Vane Angles'</span>)
Plot2D(conePlot,torqueSolved,<span class="string">'Cone Angle (deg)'</span>,<span class="string">'Torque (Nm)'</span>)
legend(<span class="string">'x'</span>,<span class="string">'y'</span>,<span class="string">'z'</span>)
Plot2D(conePlot,ks,<span class="string">'Cone Angle (deg)'</span>,<span class="string">'Iterations'</span>)
</pre><img vspace="5" hspace="5" src="SailVanesDemo_05.png" alt=""> <img vspace="5" hspace="5" src="SailVanesDemo_06.png" alt=""> <img vspace="5" hspace="5" src="SailVanesDemo_07.png" alt=""> <h2 id="19">Redo angle solving with non-ideal optical properties</h2><pre class="codeinput"><span class="comment">%-----------------------------------------------------</span>
[optical, infrared, thermal] = CP1Props;
g2 = UpdateSailOpticalProps( g, optical, thermal, infrared );
<span class="comment">% Reinitialize angles for solver</span>
theta = [theta0;theta0];
<span class="comment">% Clear disturbances of ideal model</span>
clear <span class="string">SailDisturbance</span>
<span class="comment">% Informational window</span>
iH = InformDlg( <span class="string">'Running loop of SolveVaneAngles...'</span>, <span class="string">'SailVanesDemo'</span> );
torqueSolved2 = zeros(3,length(cones));
thetas2       = zeros(2,length(cones));
ks2           = zeros(1,length(cones));
<span class="keyword">for</span> k = 1:length(cones)
  p.q  = qItoCC(:,k);
  [theta,iter] = SolveVaneAngles( Tcommand, theta, g2, env, p, d );
  p.angle = theta;
  [f, tq] = SailDisturbance( g2, p, env, d );
  torqueSolved2(:,k) = tq.total;
  thetas2(:,k) = theta;
  ks2(k) = iter;
<span class="keyword">end</span>
close(iH)

Plot2D(conePlot,[thetas*180/pi;thetas2*180/pi],<span class="string">'Cone Angle (deg)'</span>,{<span class="string">'Vane 1'</span>,<span class="string">'Vane 2'</span>},<span class="keyword">...</span>
  <span class="string">'Vane Angles for Ideal and NonIdeal Properties'</span>,<span class="string">'lin'</span>,{[1 3],[2 4]})
legend(<span class="string">'ideal'</span>,<span class="string">'CP1'</span>)
Plot2D(conePlot,[torqueSolved;torqueSolved2],<span class="string">'Cone Angle (deg)'</span>,{<span class="string">'x'</span>,<span class="string">'y'</span>,<span class="string">'z'</span>},<span class="keyword">...</span>
  <span class="string">'Torque for Ideal and NonIdeal Properties'</span>,<span class="string">'lin'</span>,{[1 4],[2 5],[3 6]})
legend(<span class="string">'ideal'</span>,<span class="string">'CP1'</span>)

<span class="comment">% Compare mean and offset angles for two cases. Mean angle is NOT constant.</span>
<span class="comment">% The different in the mean angles for nonideal properties is over 1</span>
</pre><img vspace="5" hspace="5" src="SailVanesDemo_08.png" alt=""> <img vspace="5" hspace="5" src="SailVanesDemo_09.png" alt=""> <h2 id="20">degree, while for the offset angles it is less than 0.5 degree.</h2><pre class="codeinput"><span class="comment">%--------------------------------------------------------------------------</span>
m1 = sum(thetas)/2;
m2 = sum(thetas2)/2;
d1 = thetas - repmat(m1,2,1);
d2 = thetas2 - repmat(m2,2,1);
Plot2D(conePlot,[m1;m2;m2-m1]*180/pi,<span class="string">'Cone Angle (deg)'</span>,{<span class="string">'Mean Vane Angles'</span>,<span class="string">'Difference'</span>},<span class="keyword">...</span>
  <span class="string">'Mean Vane Angles'</span>,<span class="string">'lin'</span>,{[1 2],3})
subplot(2,1,1)
legend(<span class="string">'ideal'</span>,<span class="string">'CP1'</span>)
Plot2D(conePlot,[d1;d2;d2-d1]*180/pi,<span class="string">'Cone Angle (deg)'</span>,{<span class="string">'Vane 1'</span>,<span class="string">'Vane 2'</span>,<span class="string">'Differences'</span>},<span class="keyword">...</span>
  <span class="string">'Vane Angle Offsets (deg)'</span>,<span class="string">'lin'</span>,{[1 3],[2 4],[5 6]})
legH = legend(<span class="string">'vane 1'</span>,<span class="string">'vane 2'</span>);
set(legH,<span class="string">'fontsize'</span>,9)
subplot(3,1,1)
legH = legend(<span class="string">'ideal'</span>,<span class="string">'CP1'</span>);
set(legH,<span class="string">'fontsize'</span>,9)
</pre><img vspace="5" hspace="5" src="SailVanesDemo_10.png" alt=""> <img vspace="5" hspace="5" src="SailVanesDemo_11.png" alt=""> <h2 id="21">Animate angles (ideal case) using DrawSCPlanPlugIn</h2><pre class="codeinput"><span class="comment">%---------------------------------------------------</span>
tag = DrawSCPlanPlugIn( g );
light(<span class="string">'position'</span>,uSun)
hold <span class="string">on</span>;
plot3([0 g.radius*uSun(1)],[0 g.radius*uSun(2)],[0 g.radius*uSun(3)],<span class="string">'y'</span>,<span class="string">'linewidth'</span>,3)
p.q = qItoCC;
p.angle = thetas;
<span class="keyword">for</span> k = 1:length(cones)
  g = ApplyProfileToModel( g, p, k );
  DrawSCPlanPlugIn( <span class="string">'update'</span>, tag, g )
  pause(0.4)
<span class="keyword">end</span>

<span class="comment">%--------------------------------------</span>
</pre><img vspace="5" hspace="5" src="SailVanesDemo_12.png" alt=""> <p class="footer"><br><a href="https://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2021b</a><br></p></div><!--
##### SOURCE BEGIN #####
%% Demonstrate computing angles for a sail with a pair of vanes.
% Explore effects of sail cone angle on vane control output.
% Uses a 2 vane example (PlateWithVanes).
%
%   Since version 9.
%  REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
%  See also SolveVaneAngles, SailDisturbance, Theta0, DrawSCPlanPlugIn, 
%  Cone, Constant, InformDlg, NewFig, Plot2D, TitleS, XLabelS, YLabelS, Unit, 
%  Date2JD, El2RV, ConeClockToU, QSail, DisturbanceStruct, EnvironmentStruct, 
%  ProfileStruct, SailEnvironment, CP1Props, UpdateSailOpticalProps, 
%  ApplyProfileToModel, SailPropsToAccel
%  REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
%%
%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH-
%	 Copyright 2009 Princeton Satellite Systems, Inc. 
%  All rights reserved.
%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH-

%%% Set up the problem
%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
clear SailDisturbance

%% Use a CAD model to get actual torque produced by vanes
%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH-
g = load('PlateWithVanes');

%% Define spacecraft properties
%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH-
mass  = g.mass.mass; % spacecraft mass in kg
lSail = max(max(g.component(2).v)); % sail length along one side in m
area  = sum(g.component(2).a);
acc0  = SailPropsToAccel( area, mass );

%% Vane area
%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH-
areaVane = g.component(3).a; % m2

%% Maximum torque 
%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH-
thetaMax = 80*pi/180;
Ps       = Constant('solar pressure mks');
fVane    = 2*Ps*areaVane;
Tmax     = 2*lSail*fVane*sin(thetaMax);

%% Environment and disturbance models
%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH-
d = struct;
d = EnvironmentStruct( d );
d = DisturbanceStruct( d );
d.aeroOn   = 0;
d.albedoOn = 0;
d.magOn    = 0;
d.radOn    = 0;

%% Profile: orbit, attitude
%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH-
jD    = Date2JD;
[r,v] = El2RV([Constant('au') 0 0 0 0 0],[],Constant('mu sun'));
uSun  = -Unit(r);
qS    = QSail( uSun, r, v );
p    = ProfileStruct;
p.q  = qS;
p.r  = r;
p.v  = v;
p.jD = jD;
% states for rotating vanes
p.body  = [2 3];
p.angle = [0; 0];
p.axis  = [0 0 1; 0 0 1]';

%% Environment will be constant over this short period
%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
env = SailEnvironment( 'sun', p, d );

%%% Compute full disturbances for different vane angles and sail attiude
%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
disp('Sail vanes demo REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH')

% Disturbances
[f, tq] = SailDisturbance( g, p, env, d );
disp('Torque for all zero angles - should be zero!')
tq.total

% Now rotate the vanes with the sail straight-on to the sun
p.angle = [20; 20]*pi/180;
[f, tq] = SailDisturbance( g, p, env, d );
disp('Torque for vanes angles of 20 degrees - pure roll torque')
tq.total

% Next give the sail a cone angle - see torques in other axes
cone = pi/6;
clock = 0;
[u,qItoCC] = ConeClockToU( cone, clock, qS );
p.q  = qItoCC;
[f, tq] = SailDisturbance( g, p, env, d );
disp('Torque for vanes angles of 20 degrees with cone angle of 30 degrees;')
disp('no longer a pure roll torque but evenly distributed in two axes.')
tq.total

% Now give the sail a clock angle - no change
clock = pi/4;
[u,qItoCC] = ConeClockToU( cone, clock, qS );
p.q  = qItoCC;
[f, tq] = SailDisturbance( g, p, env, d );
disp('Clock angle doesn''''t change the body torques')
tq.total

% Investigate the effect of cone angle on the three-axis torque produced
%% (Vanes don't produce a pure roll torque for nonzero cone angle)
%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH-
cones = linspace(0,pi/4,50);
clock = 0;
vanes = [10;20;30;40;50;65;80];
zz      = zeros(length(vanes),length(cones));
torqueX = zz;
torqueY = zz;
torqueZ = zz;
for k = 1:length(cones)
  [u,qItoCC(:,k)] = ConeClockToU( cones(k), clock, qS );
  p.q  = qItoCC(:,k);
  for j = 1:length(vanes)
    p.angle = vanes(j)*[1; 1]*pi/180;
    [f, tq] = SailDisturbance( g, p, env, d );
    torqueX(j,k) = tq.total(1);
    torqueY(j,k) = tq.total(2);
    torqueZ(j,k) = tq.total(3);
  end
end
conePlot = cones*180/pi;

%% Plot the curves for a single vane angle and all cone angles
%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
% Nominal curves, at 20 degrees
Plot2D(conePlot,[torqueX(2,:);torqueY(2,:);torqueZ(2,:)],'Cone Angle','Torque (Nm)','Vane Torque (20 degree rotation) with cone angle')
% Confirm typical magnitude curve when cone is zero
Plot2D(vanes',torqueX(:,1)','Vane Angle','Max Torque (Nm)','Vane Torque when sail cone angle is zero')

%% Plot the torque profiles in each axis
%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
NewFig('Torque Profiles')
TitleS('Vane Torques For Varying Cone Angle')
subplot(2,1,1)
plot(conePlot,torqueX)
YLabelS('Roll Torque (Nm)')
grid on
subplot(2,1,2)
plot(conePlot,torqueY)
grid on
YLabelS('Overturning Torque (Nm)')
XLabelS('Cone Angle')
legH = legend(num2str(vanes));
set(legH,'fontsize',9)

%%% Redo above analysis with a smaller set of vane angles
%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH-
clock = 0;
vanes = 2:2:16;
torqueX = zz;
torqueY = zz;
torqueZ = zz;
for k = 1:length(cones)
  p.q  = qItoCC(:,k);
  for j = 1:length(vanes)
    p.angle = vanes(j)*[1; 1]*pi/180;
    [f, tq] = SailDisturbance( g, p, env, d );
    torqueX(j,k) = tq.total(1);
    torqueY(j,k) = tq.total(2);
    torqueZ(j,k) = tq.total(3);
  end
end

% This figure shows that when the sail has an angle to the sun, and the
% vanes have equal angles, an overturning torque is produced in addition to
% the roll torque. This is because the vanes have different apparent areas
%% to the sun.
%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
NewFig('Torque Profiles')
subplot(2,1,1)
plot(conePlot,torqueX)
grid on
YLabelS('Roll Torque (Nm)')
TitleS('Vane Torques For Varying Cone Angle')
subplot(2,1,2)
plot(conePlot,torqueY)
grid on
YLabelS('Overturning Torque (Nm)')
XLabelS('Cone Angle')
legH = legend(num2str(vanes'));
set(legH,'fontsize',9)

%% Investigate differential vane commanding for pure roll torque
% To achieve a pure roll torque with varying sail cone angle we have to
% command the vanes to different angles. SolveVaneAngles uses Newton's
% method with a numerical Jacobian to find the combination of vane angles
%% that gives the desired torque.
%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH-
Tcommand = [0.1; 0];
% Nominal angle for roll torque, for initialization
theta0 = asin(Tcommand(1)./(2*lSail*fVane));
theta = [theta0;theta0]; 
% Initialize plot matrices
torqueSolved = zeros(3,length(cones));
thetas       = zeros(2,length(cones));
ks           = zeros(1,length(cones));
% Informational window
iH = InformDlg( 'Running loop of SolveVaneAngles...', 'SailVanesDemo' );
for k = 1:length(cones)
  p.q  = qItoCC(:,k);
  [theta,iter] = SolveVaneAngles( Tcommand, theta, g, env, p, d );
  p.angle = theta;
  [f, tq] = SailDisturbance( g, p, env, d );
  torqueSolved(:,k) = tq.total;
  thetas(:,k) = theta;
  ks(k) = iter;
end
close(iH)

% See that the average angle remains the same and pure roll torque is
% achieved. The number of iterations to meet the tolerance is shown.
%
%% A small torque is generated in the 3rd axis, increasing with cone angle.
%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH-
Plot2D(conePlot,thetas*180/pi,'Cone Angle (deg)','Vane Angles')
Plot2D(conePlot,torqueSolved,'Cone Angle (deg)','Torque (Nm)')
legend('x','y','z')
Plot2D(conePlot,ks,'Cone Angle (deg)','Iterations')

%% Redo angle solving with non-ideal optical properties
%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH-
[optical, infrared, thermal] = CP1Props;
g2 = UpdateSailOpticalProps( g, optical, thermal, infrared );
% Reinitialize angles for solver
theta = [theta0;theta0]; 
% Clear disturbances of ideal model
clear SailDisturbance
% Informational window
iH = InformDlg( 'Running loop of SolveVaneAngles...', 'SailVanesDemo' );
torqueSolved2 = zeros(3,length(cones));
thetas2       = zeros(2,length(cones));
ks2           = zeros(1,length(cones));
for k = 1:length(cones)
  p.q  = qItoCC(:,k);
  [theta,iter] = SolveVaneAngles( Tcommand, theta, g2, env, p, d );
  p.angle = theta;
  [f, tq] = SailDisturbance( g2, p, env, d );
  torqueSolved2(:,k) = tq.total;
  thetas2(:,k) = theta;
  ks2(k) = iter;
end
close(iH)

Plot2D(conePlot,[thetas*180/pi;thetas2*180/pi],'Cone Angle (deg)',{'Vane 1','Vane 2'},...
  'Vane Angles for Ideal and NonIdeal Properties','lin',{[1 3],[2 4]})
legend('ideal','CP1')
Plot2D(conePlot,[torqueSolved;torqueSolved2],'Cone Angle (deg)',{'x','y','z'},...
  'Torque for Ideal and NonIdeal Properties','lin',{[1 4],[2 5],[3 6]})
legend('ideal','CP1')

% Compare mean and offset angles for two cases. Mean angle is NOT constant.
% The different in the mean angles for nonideal properties is over 1
%% degree, while for the offset angles it is less than 0.5 degree.
%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
m1 = sum(thetas)/2;
m2 = sum(thetas2)/2;
d1 = thetas - repmat(m1,2,1);
d2 = thetas2 - repmat(m2,2,1);
Plot2D(conePlot,[m1;m2;m2-m1]*180/pi,'Cone Angle (deg)',{'Mean Vane Angles','Difference'},...
  'Mean Vane Angles','lin',{[1 2],3})
subplot(2,1,1)
legend('ideal','CP1')
Plot2D(conePlot,[d1;d2;d2-d1]*180/pi,'Cone Angle (deg)',{'Vane 1','Vane 2','Differences'},...
  'Vane Angle Offsets (deg)','lin',{[1 3],[2 4],[5 6]})
legH = legend('vane 1','vane 2');
set(legH,'fontsize',9)
subplot(3,1,1)
legH = legend('ideal','CP1');
set(legH,'fontsize',9)

%% Animate angles (ideal case) using DrawSCPlanPlugIn
%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH-
tag = DrawSCPlanPlugIn( g );
light('position',uSun)
hold on;
plot3([0 g.radius*uSun(1)],[0 g.radius*uSun(2)],[0 g.radius*uSun(3)],'y','linewidth',3)
p.q = qItoCC;
p.angle = thetas;
for k = 1:length(cones)
  g = ApplyProfileToModel( g, p, k );
  DrawSCPlanPlugIn( 'update', tag, g )
  pause(0.4)
end

%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
% $Date:   2021-12-22 $
% $Revision: 47ebd26b88c7371885d43ded1b32c94ceff2b6ba $


##### SOURCE END #####
--></body></html>