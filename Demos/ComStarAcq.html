<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
<!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      -->
<title>The acquisition sequence for the ComStar satellite.</title>
<meta name="generator" content="MATLAB 23.2">
<link rel="schema.DC" href="http://purl.org/dc/elements/1.1/">
<meta name="DC.date" content="2023-11-14">
<meta name="DC.source" content="ComStarAcq.m">
<style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; }

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }
span.typesection { color:#A0522D }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style>
</head>
<body>
<div class="content">
<h1>The acquisition sequence for the ComStar satellite.</h1>
<!--introduction-->
<p>Comstar is spinning in transfer orbit. When the demonstration starts it is at orbit normal. The acquisition sequence has the following phases:</p>
<pre class="language-matlab">1. Despin <span class="string">to</span> <span class="string">the</span> <span class="string">DST</span> <span class="string">angular</span> <span class="string">rate</span>
2. DST <span class="string">with</span> <span class="string">nutation</span> <span class="string">damping</span>
3. Pitch <span class="string">estimation</span>
4. Pitch <span class="string">acquisition</span>
5. Normal <span class="string">mode</span>
</pre>
<p>Phases 2-4 make use of the tach loop</p>
<pre class="language-matlab">Since <span class="string">version</span> <span class="string">2.</span>
-------------------------------------------------------------------------
See <span class="string">also</span> <span class="string">DSTCrit</span>, PtchLoop, SSA, SpinREst, StatePrp, FGs, NPlot,
ComStar, PitchEst, Q2Eul, Constant, Plot2D, TimeGUI, RK4
-------------------------------------------------------------------------
</pre>
<!--/introduction-->
<h2>Contents</h2>
<div>
<ul>
<li>
<a href="#2">Global for the TimeGUI</a>
</li>
<li>
<a href="#3">Constants</a>
</li>
<li>
<a href="#4">Database inputs</a>
</li>
<li>
<a href="#5">Input parameters</a>
</li>
<li>
<a href="#6">The acquisition sequence has four phases:</a>
</li>
<li>
<a href="#7">Compute an acceptable spin rate prior to the dual spin turn</a>
</li>
<li>
<a href="#8">Initialize the Spin rate controller</a>
</li>
<li>
<a href="#9">Design the tach loop</a>
</li>
<li>
<a href="#10">Get the pitch and tach loop controllers</a>
</li>
<li>
<a href="#11">Set up the pitch Kalman Filter</a>
</li>
<li>
<a href="#12">Design the thruster pitch controller</a>
</li>
<li>
<a href="#13">The main simulation loop</a>
</li>
<li>
<a href="#14">Initialize the time display</a>
</li>
</ul>
</div>
<pre class="codeinput">
<span class="comment">%-------------------------------------------------------------------------------</span>
<span class="comment">%	 Copyright 1994-1998 Princeton Satellite Systems, Inc. All rights reserved.</span>
<span class="comment">%-------------------------------------------------------------------------------</span>
</pre>
<h2 id="2">Global for the TimeGUI</h2>
<pre class="codeinput">
<span class="comment">%------------------------</span>
<span class="keyword">global</span> simulationAction
simulationAction = <span class="string">' '</span>;
</pre>
<h2 id="3">Constants</h2>
<pre class="codeinput">
<span class="comment">%----------</span>
rPSToRPM   = Constant(<span class="string">'Rad/Sec to RPM'</span>);
rPMToRPS   = Constant(<span class="string">'RPM to Rad/Sec'</span>);
degToRad   = Constant(<span class="string">'Deg to Rad'</span>);
radToDeg   = Constant(<span class="string">'Rad to Deg'</span>);
</pre>
<h2 id="4">Database inputs</h2>
<pre class="codeinput">
<span class="comment">%----------------</span>
inrMWA     = ComStar(<span class="string">'MWA Inertia'</span>);
inr        = ComStar(<span class="string">'TO Inertia'</span>);
wMWATarg   = ComStar(<span class="string">'DST MWA Target'</span>);
uMWA       = ComStar(<span class="string">'U MWA'</span>);
uDamper    = ComStar(<span class="string">'U Damper'</span>);
cDamper    = ComStar(<span class="string">'C Damper'</span>);
inrDamper  = ComStar(<span class="string">'Damper Inertia'</span>);

invInr     = inv(inr);
hMWA       = inrMWA*wMWATarg;
</pre>
<h2 id="5">Input parameters</h2>
<pre class="codeinput">
<span class="comment">%-----------------</span>
w          = [0;0;4.5]*rPMToRPS;
nSim       = 4000;
nPMax      = 10;
dTSim      = 0.25;                  <span class="comment">% Control period</span>
x          = [[1;0;0;0];w;0;0];
esaLimit   = 8.0*degToRad;
</pre>
<h2 id="6">The acquisition sequence has four phases:</h2>
<pre class="codeinput">
<span class="comment">%------------------------------------------</span>
<span class="comment">% 1. Despin to the DST angular rate</span>
<span class="comment">% 2. DST with nutation damping</span>
<span class="comment">% 3. Pitch estimation</span>
<span class="comment">% 4. Pitch acquisition</span>
<span class="comment">% 5. Normal mode</span>
<span class="comment">% Phases 2-4 make use of the tach loop</span>
</pre>
<h2 id="7">Compute an acceptable spin rate prior to the dual spin turn</h2>
<pre class="codeinput">
<span class="comment">%------------------------------------------------------------</span>
[wZMax,wZMin,wYMax] = DSTCrit(inrMWA,inr(2,2),inr(1,1),inr(3,3),hMWA);
</pre>
<h2 id="8">Initialize the Spin rate controller</h2>
<pre class="codeinput">
<span class="comment">%------------------------------------</span>
wC             = wZMin + 0.2*(wZMax-wZMin);
wY             = -(wC*inr(3,3)-hMWA)/inr(2,2);
phase          = <span class="string">'Despin'</span>;
xSpinRateEst   = x(7);
kSpinRateEst   = 0.5;
pulsewidth     = 0;
pulsewidthMax  = 0;
accelNom       = -6/inr(3,3);  <span class="comment">% Need to update this</span>
wError         = 0.01*rPMToRPS;
fprintf(<span class="string">'Minimum pre  DST z-axis spin rate         = %8.2f rpm \n'</span>,wZMin*rPSToRPM);
fprintf(<span class="string">'Maximum pre  DST z-axis spin rate         = %8.2f rpm \n'</span>,wZMax*rPSToRPM);
fprintf(<span class="string">'Maximum post DST y-axis spin rate         = %8.2f rpm \n'</span>,wYMax*rPSToRPM);
fprintf(<span class="string">'Pre  DST z-axis spin rate                 = %8.2f rpm \n'</span>,wC*rPSToRPM);
fprintf(<span class="string">'Post DST y-axis spin rate                 = %8.2f rpm \n'</span>,wY*rPSToRPM);
</pre>
<pre class="codeoutput">Minimum pre  DST z-axis spin rate         =     0.45 rpm 
Maximum pre  DST z-axis spin rate         =     1.80 rpm 
Maximum post DST y-axis spin rate         =     1.80 rpm 
Pre  DST z-axis spin rate                 =     0.72 rpm 
Post DST y-axis spin rate                 =    -0.36 rpm 
</pre>
<h2 id="9">Design the tach loop</h2>
<pre class="codeinput">
<span class="comment">%---------------------</span>
zeta         = 0.7071;
wN           = 1.0;
tSamp        = 0.25;
zetaPL       = 0.7071;
wNPL         = 0.1;
beta         = 0.0;
fprintf(<span class="string">'Tach loop damping ratio                   = %8.2f         \n'</span>,  zeta);
fprintf(<span class="string">'Tach loop undamped natural freq           = %8.2f rad/sec \n'</span>,    wN);
fprintf(<span class="string">'Tach loop sampling period                 = %8.2f sec     \n'</span>, tSamp);
fprintf(<span class="string">'Pitch loop damping ratio                  = %8.2f         \n'</span>,zetaPL);
fprintf(<span class="string">'Pitch loop undamped natural freq          = %8.2f rad/sec \n'</span>,  wNPL);
</pre>
<pre class="codeoutput">Tach loop damping ratio                   =     0.71         
Tach loop undamped natural freq           =     1.00 rad/sec 
Tach loop sampling period                 =     0.25 sec     
Pitch loop damping ratio                  =     0.71         
Pitch loop undamped natural freq          =     0.10 rad/sec 
</pre>
<h2 id="10">Get the pitch and tach loop controllers</h2>
<pre class="codeinput">
<span class="comment">%----------------------------------------</span>
[aM,bM,cM,dM,aP,bP,cP,dP] = PitchLoop(inr(2,2),inrMWA,beta,zeta,zetaPL,wN,wNPL,tSamp,<span class="string">'Delta'</span>);
</pre>
<h2 id="11">Set up the pitch Kalman Filter</h2>
<pre class="codeinput">
<span class="comment">%-------------------------------</span>
pPitchEst            = [pi^2 0;0 (0.1*pi/30)^2];
xPitchEst            = zeros(2,1);
rPitchEst            = (0.01*degToRad)^2;
qPitchEst            = (6*0.01)^2; <span class="comment">% in-lbf 1 percent thruster torque uncertainty</span>
esaPitchValid        = 8*degToRad;
covarianceThreshold  = 4.0;
</pre>
<h2 id="12">Design the thruster pitch controller</h2>
<pre class="codeinput">
<span class="comment">%-------------------------------------</span>
zetaTPL = 0.7071;
wNTPL   = 0.02;
fprintf(<span class="string">'Thruster Pitch loop damping ratio         = %8.2f         \n'</span>,zetaTPL);
fprintf(<span class="string">'Thruster Pitch loop undamped natural freq = %8.2f rad/sec \n'</span>,  wNTPL);

kTPL           = inr(2,2)*wNTPL^2;
tauTPL         = 2*zetaTPL/wNTPL;
pitchThreshold = 4*degToRad;
</pre>
<pre class="codeoutput">Thruster Pitch loop damping ratio         =     0.71         
Thruster Pitch loop undamped natural freq =     0.02 rad/sec 
</pre>
<h2 id="13">The main simulation loop</h2>
<pre class="codeinput">
<span class="comment">%-------------------------</span>
nPlot         = nSim/nPMax;
xPlot         = zeros(9,nPlot);
xPlotEst      = zeros(1,nPlot);
esaPitchPlot  = zeros(1,nPlot);
phasePlot     = zeros(1,nPlot);
tPlot         = zeros(1,nPlot);
xPlotPitchEst = zeros(2,nPlot);
pPlotPitchEst = zeros(2,nPlot);
thrusterPlot  = zeros(3,nPlot);
plotPitch     = zeros(1,nPlot);
t             = 0;
nP            = 0;
kP            = 0;
uSun          = [1;0;0];
uSunBodyOld   = uSun;
TLast         = -1;
T             = 2*pi/x(7);
tThruster     = [0;0;0];
pitchSat      = 0;
e             = [0;0;0];
pulseLeft     = 0;

phases        =  [<span class="string">'Despin        '</span>;<span class="keyword">...</span>
                  <span class="string">'Dual Spin Turn'</span>;<span class="keyword">...</span>
                  <span class="string">'Estimate Pitch'</span>;<span class="keyword">...</span>
                  <span class="string">'Acquire Pitch '</span>];
</pre>
<h2 id="14">Initialize the time display</h2>
<pre class="codeinput">
<span class="comment">%----------------------------</span>
tToGoMem.lastJD        = 0;
tToGoMem.lastStepsDone = 0;
tToGoMem.kAve          = 0;
[ ratioRealTime, tToGoMem ] =  TimeGUI( nSim, 0, tToGoMem, 0, dTSim, <span class="string">'ComStarAcq'</span> );

<span class="keyword">for</span> k = 1:nSim;

  <span class="comment">% Display the status message</span>
  <span class="comment">%---------------------------</span>
  [ ratioRealTime, tToGoMem ] = TimeGUI( nSim, k, tToGoMem, ratioRealTime, dTSim );

  <span class="comment">% Sun sensor</span>
  <span class="comment">%-----------</span>
  [cEP,dTCEP,uSunBodyOld] = SSA(x(1:4),uSun,uSunBodyOld,dTSim);

  <span class="comment">% The gyro</span>
  <span class="comment">% --------</span>
  yawRate = x(7);

  <span class="comment">% The tachometer</span>
  <span class="comment">% --------------</span>
  wSpeed = x(8);

  <span class="comment">% Earth sensor</span>
  <span class="comment">%-------------</span>
  e          = Q2Eul(x(1:4),e);
  pitch      = -e(3);
  <span class="keyword">if</span> abs(pitch) &gt; esaLimit &amp; pitchSat == 0,
    esaPitch = sign(pitch)*esaLimit;
    pitchSat = 1;
  <span class="keyword">elseif</span> abs(pitch) &lt; esaLimit,
    esaPitch = pitch;
    pitchSat = 0;
  <span class="keyword">end</span>

  <span class="comment">% Store plot data</span>
  <span class="comment">%----------------</span>
  <span class="keyword">if</span> nP == 0,
    kP                  = kP + 1;
    xPlot(:,kP)         = x;
    tPlot(kP)           = t;
    xPlotEst(kP)        = xSpinRateEst;
    xPlotPitchEst(:,kP) = xPitchEst;
    pPlotPitchEst(:,kP) = [pPitchEst(1,1);pPitchEst(2,2)];
    thrusterPlot (:,kP) = tThruster;
    esaPitchPlot(kP)    = esaPitch;
    plotPitch(kP)       = pitch;
    <span class="keyword">if</span>     ( strcmp(phase,<span class="string">'Despin'</span>        ) == 1 ),
      phasePlot(kP) = 1;
    <span class="keyword">elseif</span> ( strcmp(phase,<span class="string">'Dual Spin Turn'</span>) == 1 ),
      phasePlot(kP) = 2;
    <span class="keyword">elseif</span> ( strcmp(phase,<span class="string">'Estimate Pitch'</span>) == 1 ),
      phasePlot(kP) = 3;
    <span class="keyword">else</span>
      phasePlot(kP) = 4;
    <span class="keyword">end</span>
	nP = nPMax - 1;
  <span class="keyword">else</span>
    nP = nP - 1;
  <span class="keyword">end</span>

  <span class="comment">%-----------------------------------</span>
  <span class="comment">% The controller</span>
  <span class="comment">%-----------------------------------</span>

  <span class="comment">% Phase transition control</span>
  <span class="comment">%-------------------------</span>
  <span class="keyword">if</span>( strcmp(phase,<span class="string">'Despin'</span>) == 1 )

    <span class="keyword">if</span>( abs(xSpinRateEst - wC) &lt; wError )
      phase     = <span class="string">'Dual Spin Turn'</span>;
      xTachLoop = 0;
      wYawOld   = yawRate;
      wYawMax   = 0;
      wNutLimit = 2*degToRad;
    <span class="keyword">end</span>

  <span class="keyword">elseif</span>( strcmp(phase,<span class="string">'Dual Spin Turn'</span>) == 1 )

    wYawMax = max(wYawMax,abs(yawRate));
    <span class="keyword">if</span> yawRate*wYawOld &lt; 0,
      <span class="keyword">if</span> wYawMax &lt; wNutLimit,
        phase  = <span class="string">'Estimate Pitch'</span>;
      <span class="keyword">end</span>
      wYawMax = 0;
    <span class="keyword">end</span>
  	wYawOld  = yawRate;

  <span class="keyword">elseif</span> ( strcmp(phase,<span class="string">'Estimate Pitch'</span>) == 1 ),

    <span class="keyword">if</span>( pPitchEst(1,1) &lt; covarianceThreshold ),
      phase = <span class="string">'Acquire Pitch'</span>;
    <span class="keyword">end</span>

  <span class="keyword">end</span>

  <span class="comment">% Control System</span>
  <span class="comment">%---------------</span>
  <span class="keyword">if</span>( strcmp(phase,<span class="string">'Despin'</span>) == 1 )
    tMWA = 0;
    <span class="keyword">if</span>( cEP == 1 )
	  <span class="keyword">if</span>( TLast ~= -1 )
	    T             = t - dTCEP - TLast;
      xSpinRateEst  = SpinREst(accelNom, kSpinRateEst, xSpinRateEst, T, pulsewidth);
      pulsewidthMax = abs(2*pi/xSpinRateEst);
	    rateError     = wC-xSpinRateEst;
      pulsewidth    = min(pulsewidthMax,abs(rateError/accelNom));
	    tThruster     = sign(rateError)*[0;0;6];
	    pulseLeft     = pulsewidth - dTSim;
	  <span class="keyword">end</span>
	  TLast = t - dTCEP;
	<span class="keyword">else</span>
	  pulseLeft     = pulseLeft - dTSim;
	<span class="keyword">end</span>

	<span class="keyword">if</span> ( pulseLeft &lt; 0),
	  tThruster = [0;0;0];
	<span class="keyword">end</span>

  <span class="keyword">elseif</span> ( strcmp(phase,<span class="string">'Dual Spin Turn'</span>) == 1 ),
	wSDemand = wMWATarg;

  <span class="keyword">elseif</span> ( strcmp(phase,<span class="string">'Estimate Pitch'</span>) == 1 ),
    [xPitchEst,pPitchEst] = PitchEst(xPitchEst,pPitchEst,dTSim,inr(2,2),qPitchEst,rPitchEst,<span class="keyword">...</span>
	                                    tThruster(2),esaPitch,esaPitchValid);

  <span class="keyword">elseif</span> ( strcmp(phase,<span class="string">'Acquire Pitch'</span>) == 1 ),
    tThruster = [0;-kTPL*(tauTPL*xPitchEst(2) + xPitchEst(1));0];
    [xPitchEst,pPitchEst] = PitchEst(xPitchEst,pPitchEst,dTSim,inr(2,2),qPitchEst,rPitchEst,<span class="keyword">...</span>
	                                    tThruster(2),esaPitch,esaPitchValid);

  <span class="keyword">end</span>

  <span class="comment">% Tach loop</span>
  <span class="comment">%----------</span>
  <span class="keyword">if</span> (strcmp(phase,<span class="string">'Despin'</span>) == 0),
    [tMWA,xTachLoop] = StatePrp(aM,bM,cM,dM,xTachLoop,[wSpeed; wSDemand],<span class="string">'Delta'</span>);
  <span class="keyword">else</span>
    tMWA = 0;
  <span class="keyword">end</span>

  <span class="comment">%-----------------------------------</span>
  <span class="comment">% The simulation</span>
  <span class="comment">%-----------------------------------</span>

  x = RK4(@FGs,x,dTSim,t,inr,invInr,tThruster,[inrMWA inrDamper],[uMWA uDamper],[tMWA 0],[0 cDamper]);
  t = t + dTSim;

  <span class="comment">% Time control</span>
  <span class="comment">%-------------</span>
  <span class="keyword">switch</span> simulationAction
    <span class="keyword">case</span> <span class="string">'pause'</span>
      pause
      simulationAction = <span class="string">' '</span>;
    <span class="keyword">case</span> <span class="string">'stop'</span>
      <span class="keyword">return</span>;
    <span class="keyword">case</span> <span class="string">'plot'</span>
      <span class="keyword">break</span>;
  <span class="keyword">end</span>

<span class="keyword">end</span>

j = 1:kP;

tPlot = tPlot(j);

Plot2D(tPlot,xPlot(5:8,j),<span class="string">'Time (sec)'</span>,[<span class="string">'X and Z Rates (rad/sec)'</span>;<span class="keyword">...</span>
    <span class="string">'MWA Speed (rad/sec)    '</span>; <span class="string">'Y-Axis Rate (rad/sec)  '</span>],<span class="string">'Body Rates'</span>,<span class="keyword">...</span>
    <span class="string">'lin'</span>,[<span class="string">'[1,3]'</span>;<span class="string">'4    '</span>;<span class="string">'2    '</span>]);

Plot2D(tPlot,xPlotEst(j)-xPlot(7,j),<span class="string">'Time (sec)'</span>,<span class="keyword">...</span>
    <span class="string">'Spin Rate Estimator error (rad/sec)'</span>,<span class="string">'Estimator'</span>);

Plot2D(tPlot,[xPlotPitchEst(1,j)-plotPitch(j);xPlotPitchEst(2,j)-xPlot(6,j)]*radToDeg,<span class="keyword">...</span>
    <span class="string">'Time (sec)'</span>, [<span class="string">'Pitch Error (deg)         '</span>;<span class="keyword">...</span>
    <span class="string">'Pitch Rate Error (deg/sec)'</span>],<span class="string">'Pitch Control'</span>);

Plot2D(tPlot,[esaPitchPlot(j);plotPitch(j);xPlotPitchEst(1,j)]*radToDeg,<span class="keyword">...</span>
    <span class="string">'Time (sec)'</span>, [<span class="string">'ESAPitch (deg)'</span>; <span class="string">'Pitch (deg)   '</span>; <span class="string">'Estimate (deg)'</span>],<span class="string">'Pitch'</span>);

Plot2D(tPlot,pPlotPitchEst(1:2,j),<span class="string">'Time (sec)'</span>, [<span class="string">'Pitch Covariance     '</span>;<span class="keyword">...</span>
    <span class="string">'Pitch Rate Covariance'</span>],<span class="string">'Pitch Covariance'</span>);

Plot2D(tPlot,thrusterPlot(:,j),<span class="string">'Time (sec)'</span>,<span class="string">'Thruster torque (inlb)'</span>,<span class="string">'Thruster Torque'</span>);

NPlot(phases,phasePlot(j),tPlot,<span class="string">'Time (sec)'</span>,<span class="string">'Phase'</span>)

TimeGUI(<span class="string">'close'</span>);

<span class="comment">%--------------------------------------</span>
<span class="comment">% PSS internal file version information</span>
<span class="comment">%--------------------------------------</span>
<span class="comment">% $Date$</span>
<span class="comment">% $Id: 48b8eb62ae3deb788e31d71166037503c90efd57 $</span>
</pre>
<img vspace="5" hspace="5" src="ComStarAcq_01.png" alt=""> <img vspace="5" hspace="5" src="ComStarAcq_02.png" alt=""> <img vspace="5" hspace="5" src="ComStarAcq_03.png" alt=""> <img vspace="5" hspace="5" src="ComStarAcq_04.png" alt=""> <img vspace="5" hspace="5" src="ComStarAcq_05.png" alt=""> <img vspace="5" hspace="5" src="ComStarAcq_06.png" alt=""> <p class="footer">
<br>
<a href="https://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2023b</a>
<br>
</p>
</div>
<!--
##### SOURCE BEGIN #####
%% The acquisition sequence for the ComStar satellite. 
% Comstar is spinning in transfer orbit. When the demonstration starts it is 
% at orbit normal. The acquisition sequence has the following phases:
%
%   1. Despin to the DST angular rate
%   2. DST with nutation damping
%   3. Pitch estimation
%   4. Pitch acquisition
%   5. Normal mode
%
% Phases 2-4 make use of the tach loop
%
%   Since version 2.
% REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH-
%  See also DSTCrit, PtchLoop, SSA, SpinREst, StatePrp, FGs, NPlot, 
%  ComStar, PitchEst, Q2Eul, Constant, Plot2D, TimeGUI, RK4
% REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH-
%%
%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH-
%	 Copyright 1994-1998 Princeton Satellite Systems, Inc. All rights reserved.
%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH-

%% Global for the TimeGUI
%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
global simulationAction
simulationAction = ' ';

%% Constants
%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
rPSToRPM   = Constant('Rad/Sec to RPM');
rPMToRPS   = Constant('RPM to Rad/Sec');
degToRad   = Constant('Deg to Rad');
radToDeg   = Constant('Rad to Deg');
			     
%% Database inputs
%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
inrMWA     = ComStar('MWA Inertia'); 
inr        = ComStar('TO Inertia');   
wMWATarg   = ComStar('DST MWA Target');
uMWA       = ComStar('U MWA'); 
uDamper    = ComStar('U Damper'); 
cDamper    = ComStar('C Damper');
inrDamper  = ComStar('Damper Inertia');

invInr     = inv(inr);
hMWA       = inrMWA*wMWATarg;  

%% Input parameters
%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH-
w          = [0;0;4.5]*rPMToRPS;
nSim       = 4000;
nPMax      = 10;
dTSim      = 0.25;                  % Control period
x          = [[1;0;0;0];w;0;0];
esaLimit   = 8.0*degToRad;

%% The acquisition sequence has four phases:
%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
% 1. Despin to the DST angular rate
% 2. DST with nutation damping
% 3. Pitch estimation
% 4. Pitch acquisition
% 5. Normal mode
% Phases 2-4 make use of the tach loop

%% Compute an acceptable spin rate prior to the dual spin turn
%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
[wZMax,wZMin,wYMax] = DSTCrit(inrMWA,inr(2,2),inr(1,1),inr(3,3),hMWA);

%% Initialize the Spin rate controller
%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
wC             = wZMin + 0.2*(wZMax-wZMin);
wY             = -(wC*inr(3,3)-hMWA)/inr(2,2);
phase          = 'Despin';
xSpinRateEst   = x(7);
kSpinRateEst   = 0.5;
pulsewidth     = 0;
pulsewidthMax  = 0;
accelNom       = -6/inr(3,3);  % Need to update this
wError         = 0.01*rPMToRPS;
fprintf('Minimum pre  DST z-axis spin rate         = %8.2f rpm \n',wZMin*rPSToRPM);
fprintf('Maximum pre  DST z-axis spin rate         = %8.2f rpm \n',wZMax*rPSToRPM);
fprintf('Maximum post DST y-axis spin rate         = %8.2f rpm \n',wYMax*rPSToRPM);
fprintf('Pre  DST z-axis spin rate                 = %8.2f rpm \n',wC*rPSToRPM);
fprintf('Post DST y-axis spin rate                 = %8.2f rpm \n',wY*rPSToRPM);

%% Design the tach loop
%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH-
zeta         = 0.7071;
wN           = 1.0;
tSamp        = 0.25;
zetaPL       = 0.7071;
wNPL         = 0.1;
beta         = 0.0;
fprintf('Tach loop damping ratio                   = %8.2f         \n',  zeta);
fprintf('Tach loop undamped natural freq           = %8.2f rad/sec \n',    wN);
fprintf('Tach loop sampling period                 = %8.2f sec     \n', tSamp);
fprintf('Pitch loop damping ratio                  = %8.2f         \n',zetaPL);
fprintf('Pitch loop undamped natural freq          = %8.2f rad/sec \n',  wNPL);

%% Get the pitch and tach loop controllers
%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
[aM,bM,cM,dM,aP,bP,cP,dP] = PitchLoop(inr(2,2),inrMWA,beta,zeta,zetaPL,wN,wNPL,tSamp,'Delta'); 

%% Set up the pitch Kalman Filter
%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH-
pPitchEst            = [pi^2 0;0 (0.1*pi/30)^2];
xPitchEst            = zeros(2,1);
rPitchEst            = (0.01*degToRad)^2;
qPitchEst            = (6*0.01)^2; % in-lbf 1 percent thruster torque uncertainty
esaPitchValid        = 8*degToRad;
covarianceThreshold  = 4.0;

%% Design the thruster pitch controller
%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH-
zetaTPL = 0.7071;
wNTPL   = 0.02;
fprintf('Thruster Pitch loop damping ratio         = %8.2f         \n',zetaTPL);
fprintf('Thruster Pitch loop undamped natural freq = %8.2f rad/sec \n',  wNTPL);

kTPL           = inr(2,2)*wNTPL^2;
tauTPL         = 2*zetaTPL/wNTPL;
pitchThreshold = 4*degToRad;

%% The main simulation loop
%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH-
nPlot         = nSim/nPMax;
xPlot         = zeros(9,nPlot);
xPlotEst      = zeros(1,nPlot);
esaPitchPlot  = zeros(1,nPlot);
phasePlot     = zeros(1,nPlot);
tPlot         = zeros(1,nPlot);
xPlotPitchEst = zeros(2,nPlot);
pPlotPitchEst = zeros(2,nPlot);
thrusterPlot  = zeros(3,nPlot);
plotPitch     = zeros(1,nPlot);
t             = 0;
nP            = 0;
kP            = 0;
uSun          = [1;0;0];
uSunBodyOld   = uSun;
TLast         = -1;
T             = 2*pi/x(7);
tThruster     = [0;0;0];
pitchSat      = 0;
e             = [0;0;0];
pulseLeft     = 0; 

phases        =  ['Despin        ';... 
                  'Dual Spin Turn';...  
                  'Estimate Pitch';... 
                  'Acquire Pitch '];


%% Initialize the time display
%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
tToGoMem.lastJD        = 0; 
tToGoMem.lastStepsDone = 0; 
tToGoMem.kAve          = 0;
[ ratioRealTime, tToGoMem ] =  TimeGUI( nSim, 0, tToGoMem, 0, dTSim, 'ComStarAcq' );

for k = 1:nSim; 

  % Display the status message
  %REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH-
  [ ratioRealTime, tToGoMem ] = TimeGUI( nSim, k, tToGoMem, ratioRealTime, dTSim );
  
  % Sun sensor
  %REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH-
  [cEP,dTCEP,uSunBodyOld] = SSA(x(1:4),uSun,uSunBodyOld,dTSim);

  % The gyro
  % REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
  yawRate = x(7);

  % The tachometer
  % REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
  wSpeed = x(8);
  
  % Earth sensor
  %REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH-
  e          = Q2Eul(x(1:4),e);
  pitch      = -e(3);
  if abs(pitch) > esaLimit & pitchSat == 0,
    esaPitch = sign(pitch)*esaLimit;
    pitchSat = 1;
  elseif abs(pitch) < esaLimit,
    esaPitch = pitch;
    pitchSat = 0;
  end
  
  % Store plot data
  %REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
  if nP == 0,
    kP                  = kP + 1; 
    xPlot(:,kP)         = x;
    tPlot(kP)           = t;
    xPlotEst(kP)        = xSpinRateEst;
    xPlotPitchEst(:,kP) = xPitchEst;
    pPlotPitchEst(:,kP) = [pPitchEst(1,1);pPitchEst(2,2)];
    thrusterPlot (:,kP) = tThruster;
    esaPitchPlot(kP)    = esaPitch;
    plotPitch(kP)       = pitch;
    if     ( strcmp(phase,'Despin'        ) == 1 ),
      phasePlot(kP) = 1;
    elseif ( strcmp(phase,'Dual Spin Turn') == 1 ),
      phasePlot(kP) = 2;
    elseif ( strcmp(phase,'Estimate Pitch') == 1 ),
      phasePlot(kP) = 3;
    else
      phasePlot(kP) = 4;
    end
	nP = nPMax - 1;
  else
    nP = nP - 1;  
  end

  %REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH-
  % The controller
  %REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH-

  % Phase transition control
  %REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH-
  if( strcmp(phase,'Despin') == 1 )
  
    if( abs(xSpinRateEst - wC) < wError )
      phase     = 'Dual Spin Turn'; 
      xTachLoop = 0;
      wYawOld   = yawRate;
      wYawMax   = 0;
      wNutLimit = 2*degToRad;
    end
	
  elseif( strcmp(phase,'Dual Spin Turn') == 1 )
  
    wYawMax = max(wYawMax,abs(yawRate)); 
    if yawRate*wYawOld < 0,
      if wYawMax < wNutLimit,
        phase  = 'Estimate Pitch';
      end 
      wYawMax = 0;
    end 
  	wYawOld  = yawRate;
	
  elseif ( strcmp(phase,'Estimate Pitch') == 1 ),
  
    if( pPitchEst(1,1) < covarianceThreshold ),
      phase = 'Acquire Pitch';
    end
	
  end

  % Control System
  %REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH-
  if( strcmp(phase,'Despin') == 1 ) 
    tMWA = 0;
    if( cEP == 1 )
	  if( TLast ~= -1 ) 
	    T             = t - dTCEP - TLast;
      xSpinRateEst  = SpinREst(accelNom, kSpinRateEst, xSpinRateEst, T, pulsewidth); 
      pulsewidthMax = abs(2*pi/xSpinRateEst);
	    rateError     = wC-xSpinRateEst;
      pulsewidth    = min(pulsewidthMax,abs(rateError/accelNom)); 
	    tThruster     = sign(rateError)*[0;0;6];
	    pulseLeft     = pulsewidth - dTSim;
	  end
	  TLast = t - dTCEP;
	else
	  pulseLeft     = pulseLeft - dTSim;
	end

	if ( pulseLeft < 0),
	  tThruster = [0;0;0];
	end
	
  elseif ( strcmp(phase,'Dual Spin Turn') == 1 ),
	wSDemand = wMWATarg;
	
  elseif ( strcmp(phase,'Estimate Pitch') == 1 ),
    [xPitchEst,pPitchEst] = PitchEst(xPitchEst,pPitchEst,dTSim,inr(2,2),qPitchEst,rPitchEst,...
	                                    tThruster(2),esaPitch,esaPitchValid);
										
  elseif ( strcmp(phase,'Acquire Pitch') == 1 ),
    tThruster = [0;-kTPL*(tauTPL*xPitchEst(2) + xPitchEst(1));0];
    [xPitchEst,pPitchEst] = PitchEst(xPitchEst,pPitchEst,dTSim,inr(2,2),qPitchEst,rPitchEst,...
	                                    tThruster(2),esaPitch,esaPitchValid);
										
  end
  
  % Tach loop
  %REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
  if (strcmp(phase,'Despin') == 0),
    [tMWA,xTachLoop] = StatePrp(aM,bM,cM,dM,xTachLoop,[wSpeed; wSDemand],'Delta'); 
  else
    tMWA = 0;
  end

  %REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH-
  % The simulation
  %REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH-

  x = RK4(@FGs,x,dTSim,t,inr,invInr,tThruster,[inrMWA inrDamper],[uMWA uDamper],[tMWA 0],[0 cDamper]);
  t = t + dTSim;
  
  % Time control
  %REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH-
  switch simulationAction
    case 'pause'
      pause
      simulationAction = ' ';
    case 'stop'
      return;
    case 'plot'
      break;
  end
  
end

j = 1:kP;

tPlot = tPlot(j);

Plot2D(tPlot,xPlot(5:8,j),'Time (sec)',['X and Z Rates (rad/sec)';...
    'MWA Speed (rad/sec)    '; 'Y-Axis Rate (rad/sec)  '],'Body Rates',...
    'lin',['[1,3]';'4    ';'2    ']);
										
Plot2D(tPlot,xPlotEst(j)-xPlot(7,j),'Time (sec)',...
    'Spin Rate Estimator error (rad/sec)','Estimator');

Plot2D(tPlot,[xPlotPitchEst(1,j)-plotPitch(j);xPlotPitchEst(2,j)-xPlot(6,j)]*radToDeg,...
    'Time (sec)', ['Pitch Error (deg)         ';...
    'Pitch Rate Error (deg/sec)'],'Pitch Control');
						   
Plot2D(tPlot,[esaPitchPlot(j);plotPitch(j);xPlotPitchEst(1,j)]*radToDeg,...
    'Time (sec)', ['ESAPitch (deg)'; 'Pitch (deg)   '; 'Estimate (deg)'],'Pitch');

Plot2D(tPlot,pPlotPitchEst(1:2,j),'Time (sec)', ['Pitch Covariance     ';...
    'Pitch Rate Covariance'],'Pitch Covariance');

Plot2D(tPlot,thrusterPlot(:,j),'Time (sec)','Thruster torque (inlb)','Thruster Torque');

NPlot(phases,phasePlot(j),tPlot,'Time (sec)','Phase')

TimeGUI('close');

%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
% PSS internal file version information
%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
% $Date$
% $Id: 48b8eb62ae3deb788e31d71166037503c90efd57 $

##### SOURCE END #####
-->
</body>
</html>
