<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
<!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      -->
<title>CubeSatPowerDemo</title>
<meta name="generator" content="MATLAB 23.2">
<link rel="schema.DC" href="http://purl.org/dc/elements/1.1/">
<meta name="DC.date" content="2023-11-14">
<meta name="DC.source" content="CubeSatPowerDemo.m">
<style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; }

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }
span.typesection { color:#A0522D }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style>
</head>
<body>
<div class="content">
<h2>Contents</h2>
<div>
<ul>
<li>
<a href="#1">Power computation over several orbits.</a>
</li>
<li>
<a href="#3">Constants</a>
</li>
<li>
<a href="#4">Battery parameters</a>
</li>
<li>
<a href="#5">Compute semi-major axis from altitude</a>
</li>
<li>
<a href="#6">We need the date in Julian Centuries for the sun model</a>
</li>
<li>
<a href="#7">Compute trajectory from orbital elements</a>
</li>
<li>
<a href="#8">CubeSat model including the deployed solar panels</a>
</li>
<li>
<a href="#9">Initialize the array to save time</a>
</li>
<li>
<a href="#10">Track LVLH coordinates;</a>
</li>
<li>
<a href="#11">Compute the power in a loop</a>
</li>
<li>
<a href="#12">Size the battery</a>
</li>
</ul>
</div>
<h2 id="1">Power computation over several orbits.</h2>
<p>Create a CubeSat model with large deployed arrays. Compute the power generated by the arrays assuming LVLH pointing.</p>
<pre class="codeinput">
<span class="comment">%------------------------------------------------------------------------</span>
<span class="comment">%  See also RVFromKepler, Date2JD, JD2T, julianCent, SunV1, Eclipse,</span>
<span class="comment">%  SolarCellPower</span>
<span class="comment">%------------------------------------------------------------------------</span>
</pre>
<pre class="codeinput">
<span class="comment">%--------------------------------------------------------------------------</span>
<span class="comment">%   Copyright (c) 2011, 2020 Princeton Satellite Systems.</span>
<span class="comment">%   All Rights Reserved.</span>
<span class="comment">%--------------------------------------------------------------------------</span>
<span class="comment">%   Since 2020.1</span>
<span class="comment">%--------------------------------------------------------------------------</span>
</pre>
<h2 id="3">Constants</h2>
<pre class="codeinput">solarFlux   = 1367;             <span class="comment">% W</span>
radiusEarth = 6378.165;         <span class="comment">% km</span>
</pre>
<h2 id="4">Battery parameters</h2>
<pre class="codeinput">capacity    = 7.4*0.830;        <span class="comment">% W-hr</span>
dOD         = 0.6;              <span class="comment">% Depth of discharge</span>
</pre>
<h2 id="5">Compute semi-major axis from altitude</h2>
<pre class="codeinput">altitude    = 500;              <span class="comment">% km</span>
inc         = 51.6*pi/180;   <span class="comment">% deg - launch from KSFC</span>
sma         = radiusEarth + altitude;
</pre>
<h2 id="6">We need the date in Julian Centuries for the sun model</h2>
<pre class="codeinput">jD0         = Date2JD([2021 1 2 0 0 0]);
t           = linspace(0,6*3600,300);
julianDate  = jD0 + t/86400;
</pre>
<h2 id="7">Compute trajectory from orbital elements</h2>
<pre class="codeinput">[rs,vs,t]   = RVFromKepler( [sma inc 0 0 0 0], t );
m           = length(t);
PlotOrbit( rs, t, jD0 );
</pre>
<img vspace="5" hspace="5" src="CubeSatPowerDemo_01.png" alt=""> <h2 id="8">CubeSat model including the deployed solar panels</h2>
<pre class="codeinput">d                       = CubeSatModel( <span class="string">'struct'</span> );
d.massComponents        = 3;
d.solarPanel.dim        = [100 100 10];	<span class="comment">% [side attached to cubesat, side perpendicular, thickness]</span>
d.solarPanel.nPanels    = 3; <span class="comment">% Number of panels per wing</span>
d.solarPanel.rPanel     = [-150 -150 -150 -150;100 200 -100 -200;50 50 50 50]; <span class="comment">% Location of inner edge of panel</span>
d.solarPanel.sPanel     = [1 1 1 1;0 0 0 0;0 0 0 0];
d.solarPanel.cellNormal = [0 0 0 0;0 0 0 0;1 1 1 1]; <span class="comment">% Cell normal</span>
d.solarPanel.sigmaCell  = [1;0;0];    <span class="comment">% [absorbed; specular; diffuse]</span>
d.solarPanel.sigmaBack  = [0;0;1];    <span class="comment">% [absorbed; specular; diffuse]</span>
d.solarPanel.mass       = 0.1;

[v, f, data]            = CubeSatModel( [3 1 1], d );
hF                      = DrawCubeSat( v, f, data );
</pre>
<img vspace="5" hspace="5" src="CubeSatPowerDemo_02.png" alt=""> <h2 id="9">Initialize the array to save time</h2>
<pre class="codeinput">dT                      = t(2) - t(1);
tE                      = 0;
p                       = zeros(1,m);
nEcl                    = zeros(1,m);
uSunBody                = zeros(3,m);
uNadir                  = zeros(3,m);
</pre>
<h2 id="10">Track LVLH coordinates;</h2>
<p>z is in the -r direction y is in the - rxv direction x completes the set; along v in a circular orbit q transforms from ECI to LVLH coordinates</p>
<pre class="codeinput">qs     = QLVLH(rs,vs);
qPoint = Eul2Q( [pi;0;0] );   <span class="comment">% Swap Z axes by rotating 180 around X</span>
</pre>
<h2 id="11">Compute the power in a loop</h2>
<pre class="codeinput">
<span class="keyword">for</span> k = 1:m
	[uSun, rSun]	= SunV1( julianDate(k) );
	nEcl(k)       = Eclipse( rs(:,k), rSun*uSun );
  qECIToBody    = QMult( qs(:,k), qPoint );
  uSunBody(:,k) = QForm(qECIToBody,uSun); <span class="comment">% the vector to the sun, body frame</span>
  uNadir(:,k)   = QForm(qECIToBody,-Unit(rs(:,k))); <span class="comment">% vector to the Earth</span>
  pSunBody      = solarFlux*nEcl(k)*uSunBody(:,k);
	p(k)          = SolarCellPower( data.power, pSunBody );
	tE            = (1-nEcl(k))*dT + tE;
  <span class="keyword">if</span> 1
    <span class="keyword">if</span> k == 1
      figure(hF)
      hA = gca;
      q(1) = quiver3(hA,0,0,0,uSunBody(1,k),uSunBody(2,k),uSunBody(3,k),0.5,<span class="string">'color'</span>,[0.93 0.69 0.13]);
      q(2) = quiver3(hA,0,0,0,uNadir(1,k),uNadir(2,k),uNadir(3,k),0.5,<span class="string">'color'</span>,[0 0.8 0.1]);
      aa = axis;
      limit = max(abs(aa));
      axis(limit*[-1 1 -1 1 -1 1]);
    <span class="keyword">else</span>
      set(q(1),<span class="string">'UData'</span>,uSunBody(1,k));
      set(q(1),<span class="string">'VData'</span>,uSunBody(2,k));
      set(q(1),<span class="string">'WData'</span>,uSunBody(3,k));
      set(q(2),<span class="string">'UData'</span>,uNadir(1,k));
      set(q(2),<span class="string">'VData'</span>,uNadir(2,k));
      set(q(2),<span class="string">'WData'</span>,uNadir(3,k));
      pause(0.1)
    <span class="keyword">end</span>
  <span class="keyword">end</span>
<span class="keyword">end</span>

tOrb = Period(sma);
Plot2D(t/tOrb,qs,<span class="string">'Time (orbits)'</span>, {<span class="string">'q_1'</span> <span class="string">'q_x'</span>, <span class="string">'q_y'</span> <span class="string">'q_z'</span>}, <span class="string">'LVLH Quaternion'</span> );
Plot2D(t/tOrb,[rs;p],<span class="string">'Time (orbits)'</span>, {<span class="string">'x (km)'</span> <span class="string">'y (km)'</span>, <span class="string">'z (km)'</span> <span class="string">'Power (W)'</span>}, <span class="string">'Power'</span> );
hold <span class="string">on</span>
plot(t/tOrb,max(p)*nEcl,<span class="string">'k'</span>)
legend(<span class="string">'Power'</span>,<span class="string">'Sun'</span>)
</pre>
<img vspace="5" hspace="5" src="CubeSatPowerDemo_03.png" alt=""> <img vspace="5" hspace="5" src="CubeSatPowerDemo_04.png" alt=""> <img vspace="5" hspace="5" src="CubeSatPowerDemo_05.png" alt=""> <h2 id="12">Size the battery</h2>
<pre class="codeinput">pTotal          = sum(p)*dT;
pAve            = pTotal/t(end);
pStored         = pAve*tE/3600;
batteryCapacity = pStored/(1-dOD);

fprintf(<span class="string">'Total time         %8.1f hr\n'</span>,t(end)/3600);
fprintf(<span class="string">'Eclipse Time       %8.1f hr\n'</span>,tE/3600);
fprintf(<span class="string">'Total power input  %8.1f Wh\n'</span>,pTotal/3600);
fprintf(<span class="string">'Depth of discharge %8.1f%%\n'</span>,dOD*100);
fprintf(<span class="string">'Battery Storage    %8.1f Wh\n'</span>,pStored);
fprintf(<span class="string">'Battery Capacity   %8.1f Wh\n'</span>,batteryCapacity);
fprintf(<span class="string">'Li-Ion Polymer     %8.1f Wh\n'</span>,capacity);

<span class="comment">%--------------------------------------</span>
<span class="comment">% $Date$</span>
<span class="comment">% $Id: fe447f255c71e0bfbbd3155edf654c478aa1cb05 $</span>
</pre>
<pre class="codeoutput">Total time              6.0 hr
Eclipse Time            2.3 hr
Total power input      60.9 Wh
Depth of discharge     60.0%
Battery Storage        23.0 Wh
Battery Capacity       57.5 Wh
Li-Ion Polymer          6.1 Wh
</pre>
<p class="footer">
<br>
<a href="https://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2023b</a>
<br>
</p>
</div>
<!--
##### SOURCE BEGIN #####
%% Power computation over several orbits.
% Create a CubeSat model with large deployed arrays. Compute the power generated
% by the arrays assuming LVLH pointing.
%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
%  See also RVFromKepler, Date2JD, JD2T, julianCent, SunV1, Eclipse,
%  SolarCellPower
%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
%%
%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
%   Copyright (c) 2011, 2020 Princeton Satellite Systems.
%   All Rights Reserved.
%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
%   Since 2020.1
%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH

%% Constants
solarFlux   = 1367;             % W
radiusEarth = 6378.165;         % km

%% Battery parameters
capacity    = 7.4*0.830;        % W-hr
dOD         = 0.6;              % Depth of discharge

%% Compute semi-major axis from altitude
altitude    = 500;              % km
inc         = 51.6*pi/180;   % deg - launch from KSFC
sma         = radiusEarth + altitude;

%% We need the date in Julian Centuries for the sun model
jD0         = Date2JD([2021 1 2 0 0 0]);
t           = linspace(0,6*3600,300);
julianDate  = jD0 + t/86400;

%% Compute trajectory from orbital elements
[rs,vs,t]   = RVFromKepler( [sma inc 0 0 0 0], t );
m           = length(t);
PlotOrbit( rs, t, jD0 );

%% CubeSat model including the deployed solar panels
d                       = CubeSatModel( 'struct' );
d.massComponents        = 3;
d.solarPanel.dim        = [100 100 10];	% [side attached to cubesat, side perpendicular, thickness]
d.solarPanel.nPanels    = 3; % Number of panels per wing
d.solarPanel.rPanel     = [-150 -150 -150 -150;100 200 -100 -200;50 50 50 50]; % Location of inner edge of panel
d.solarPanel.sPanel     = [1 1 1 1;0 0 0 0;0 0 0 0];
d.solarPanel.cellNormal = [0 0 0 0;0 0 0 0;1 1 1 1]; % Cell normal
d.solarPanel.sigmaCell  = [1;0;0];    % [absorbed; specular; diffuse]
d.solarPanel.sigmaBack  = [0;0;1];    % [absorbed; specular; diffuse]
d.solarPanel.mass       = 0.1;

[v, f, data]            = CubeSatModel( [3 1 1], d );
hF                      = DrawCubeSat( v, f, data );

%% Initialize the array to save time
dT                      = t(2) - t(1);
tE                      = 0;
p                       = zeros(1,m);
nEcl                    = zeros(1,m);
uSunBody                = zeros(3,m);
uNadir                  = zeros(3,m);

%% Track LVLH coordinates;
% z is in the -r direction
% y is in the - rxv direction
% x completes the set; along v in a circular orbit
% q transforms from ECI to LVLH coordinates
qs     = QLVLH(rs,vs);
qPoint = Eul2Q( [pi;0;0] );   % Swap Z axes by rotating 180 around X

%% Compute the power in a loop
for k = 1:m
	[uSun, rSun]	= SunV1( julianDate(k) );
	nEcl(k)       = Eclipse( rs(:,k), rSun*uSun );
  qECIToBody    = QMult( qs(:,k), qPoint );
  uSunBody(:,k) = QForm(qECIToBody,uSun); % the vector to the sun, body frame
  uNadir(:,k)   = QForm(qECIToBody,-Unit(rs(:,k))); % vector to the Earth
  pSunBody      = solarFlux*nEcl(k)*uSunBody(:,k);
	p(k)          = SolarCellPower( data.power, pSunBody );
	tE            = (1-nEcl(k))*dT + tE;
  if 1
    if k == 1
      figure(hF)
      hA = gca;
      q(1) = quiver3(hA,0,0,0,uSunBody(1,k),uSunBody(2,k),uSunBody(3,k),0.5,'color',[0.93 0.69 0.13]);
      q(2) = quiver3(hA,0,0,0,uNadir(1,k),uNadir(2,k),uNadir(3,k),0.5,'color',[0 0.8 0.1]);
      aa = axis;
      limit = max(abs(aa));
      axis(limit*[-1 1 -1 1 -1 1]);
    else
      set(q(1),'UData',uSunBody(1,k));
      set(q(1),'VData',uSunBody(2,k));
      set(q(1),'WData',uSunBody(3,k));
      set(q(2),'UData',uNadir(1,k));
      set(q(2),'VData',uNadir(2,k));
      set(q(2),'WData',uNadir(3,k));
      pause(0.1)
    end
  end
end

tOrb = Period(sma);
Plot2D(t/tOrb,qs,'Time (orbits)', {'q_1' 'q_x', 'q_y' 'q_z'}, 'LVLH Quaternion' );
Plot2D(t/tOrb,[rs;p],'Time (orbits)', {'x (km)' 'y (km)', 'z (km)' 'Power (W)'}, 'Power' );
hold on
plot(t/tOrb,max(p)*nEcl,'k')
legend('Power','Sun')

%% Size the battery
pTotal          = sum(p)*dT;
pAve            = pTotal/t(end);
pStored         = pAve*tE/3600;
batteryCapacity = pStored/(1-dOD);

fprintf('Total time         %8.1f hr\n',t(end)/3600);
fprintf('Eclipse Time       %8.1f hr\n',tE/3600);
fprintf('Total power input  %8.1f Wh\n',pTotal/3600);
fprintf('Depth of discharge %8.1f%%\n',dOD*100);
fprintf('Battery Storage    %8.1f Wh\n',pStored);
fprintf('Battery Capacity   %8.1f Wh\n',batteryCapacity);
fprintf('Li-Ion Polymer     %8.1f Wh\n',capacity);

%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
% $Date$
% $Id: fe447f255c71e0bfbbd3155edf654c478aa1cb05 $

##### SOURCE END #####
-->
</body>
</html>
